<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HiFi Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>

<script>
const socket = io();

// When backend sends an update:
socket.on("status_update", function(data) {
    // Update running indicators
    for (let comp in data.running) {
        const el = document.querySelector(".run-indicator-" + comp);
        if (data.running[comp]) el.classList.add("on");
        else el.classList.remove("on");
    }

    // Update selected indicators
    for (let comp in data.selected) {
        const el = document.querySelector(".select-" + comp);
        if (data.selected[comp]) el.classList.add("on");
        else el.classList.remove("on");
        const backlight = document.getElementById('vu-backlight-' + comp);
        if (data.selected[comp]) backlight.classList.add("on");
        else backlight.classList.remove("on");
    }
});

socket.on("vu", function(data) {
    // Update VU meters
    for (const comp in data.vu) {
        const needle = document.getElementById('vu-' + comp);
        if (!needle) continue;

        // Map 0..100 to -45deg..+45deg
        const angle = (data.vu[comp] / 100) * 90 - 45;
        needle.style.transform = `rotate(${angle}deg)`;
    }
});
</script>
<style>
  /* ------------------------ */
  /* Base body */
  body {
    margin: 0;
    font-family: "Arial", sans-serif;
    background: #222;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* ------------------------ */
  /* Header / Kill All column */
  .dashboard {
    display: flex;
    flex: 0 0 300px;       /* Fixed height */
    width: 100%;
    background: #333;
    box-shadow: inset 0 -4px 8px rgba(0,0,0,0.7), inset 0 4px 8px rgba(255,255,255,0.05);
  }

  /* Each column */
  .column {
    flex: 1;
    margin: 5px;
    background: linear-gradient(145deg, #444, #222);
    border: 2px solid #666;
    border-radius: 10px;
    box-shadow: inset -2px -2px 4px rgba(255,255,255,0.1),
                inset 2px 2px 4px rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    padding: 10px;
  }

  /* Select button */
  .select-button {
      flex: 0 0 50px;
      width: 100%;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      line-height: 50px;
      cursor: pointer;
      border-radius: 5px;
      border: 2px solid #555;
      transition: all 0.2s;
  }

  /* Select state colors */
  .select-button.on {
      background: #4caf50;
      color: black;
      border-color: #2e7d32;
  }

  .select-button {
      background: #555;
      color: #eee;
      border-color: #333;
  }

  /* Button row */
  .button-row {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
  }

  /* Button style */
  .btn {
    position: relative;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid #999;
    background: linear-gradient(145deg, #555, #222);
    box-shadow: inset -2px -2px 4px rgba(255,255,255,0.2),
                inset 2px 2px 4px rgba(0,0,0,0.7),
                2px 2px 5px rgba(0,0,0,0.5);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #eee;
    font-size: 22px;
  }

  /* Status indicator */
  .indicator {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background: #555;
    border: 1px solid #222;
    box-shadow: 0 0 4px rgba(0,0,0,0.7);
  }

  .indicator.on {
    background: #0f0;
    box-shadow: 0 0 6px #0f0;
  }

  /* Kill All column */
  .kill-column {
    flex: 0 0 150px;
    margin: 5px;
    background: linear-gradient(145deg, #333, #111);
    border: 2px solid #666;
    border-radius: 10px;
    box-shadow: inset -2px -2px 4px rgba(255,255,255,0.1),
                inset 2px 2px 4px rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 10px;
  }

  .kill-column .btn {
    width: 80px;
    height: 80px;
    font-size: 28px;
    border-color: #c33;
    background: linear-gradient(145deg, #922, #511);
    box-shadow: inset -2px -2px 6px rgba(255,100,100,0.2),
                inset 2px 2px 6px rgba(0,0,0,0.7),
                2px 2px 6px rgba(0,0,0,0.5);
  }

  /* Icon styles (optional) */
  .btn i {
    pointer-events: none;
  }

  /* VU-meters */
  .vu-meter {
    position: relative;
    width: 100%;
    height: 120px;
    margin: 10px auto;
    background: rgba(255,188,50,0.3);
    border-radius: 6px;
    box-shadow: inset 0 0 15px rgba(255,200,0,0.3);
    overflow: hidden;
  }

  .vu-backlight {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(circle at bottom, rgba(255,188,0,0.4), transparent 100%);
    pointer-events: none;
  }
  .vu-backlight.on {
    background: radial-gradient(circle at bottom, rgba(255,188,0,1.0), transparent 100%);
  }

  .vu-needle {
    position: absolute;
    bottom: -50px;
    left: 50%;
    width: 4px;
    height: 150px;
    background: red;
    transform-origin: bottom center;
    transform: rotate(-45deg); /* initial angle */
    transition: transform 0.1s ease-out;
    filter: drop-shadow(4px 2px 4px rgba(0,0,0,0.6));
  }

</style>

</head>
<body>

<div class="dashboard">
  <!-- Kill All column -->
  <div class="kill-column">
    <button class="btn" onclick="killAll()">⏻</button>
  </div>

  <!-- Component columns -->
  {% for comp in components %}
  <div class="column">
    <div class="select-button select-{{ loop.index }}"
         onclick="selectComponent({{ loop.index }})">
        {{ comp["name"] }}
    </div>

    <div class="button-row">
      <!-- Launch button -->
      <div style="position: relative;">
        <button class="btn" onclick="toggleComponent({{ loop.index }})">⏻</button>
            <div class="indicator run-indicator-{{ loop.index }}"></div>
      </div>

    </div>

    <!-- Placeholder for VU meter -->
    <div class="vu-meter">
        <div class="vu-backlight" id="vu-backlight-{{ loop.index }}"></div>
        <div class="vu-needle" id="vu-{{ loop.index }}"></div>
    </div>
  </div>
  {% endfor %}
</div>

<script src="{{ url_for('static', filename='dashboard.js') }}"></script>
</body>
</html>
